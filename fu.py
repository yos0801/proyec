# Importamos las librerias pandas y numpy
import pandas as pd
import numpy as np
import scipy.stats as stats

# Importamos la libreria yahoo finance
import yfinance as yf

# Importamos
import cufflinks as cf
cf.set_config_file(offline=True)
import plotly.graph_objects as go
from numpy.linalg import multi_dot
import scipy.optimize as sco
import streamlit as st



def obtener_datos_acciones(simbolos, start_date, end_date):
    data = yf.download(simbolos, start=start_date, end=end_date)['Close']
    return data.ffill().dropna()

def calcular_rendimientos(df):
    returns = df.pct_change().dropna()
    return returns

def calcular_metricas(df):
    returns = df.pct_change().dropna()
    cumulative_returns = (1 + returns).cumprod() - 1
    normalized_prices = df / df.iloc[0] * 100
    return returns, cumulative_returns, normalized_prices

def calcular_rendimientos_portafolio(returns, weights):
    return (returns * weights).sum(axis=1)

def calcular_rendimiento_ventana(returns, window):
    if len(returns) < window:
        return np.nan
    return (1 + returns.iloc[-window:]).prod() - 1

def calcular_beta(asset_returns, market_returns):
    covariance = np.cov(asset_returns, market_returns)[0, 1]
    market_variance = np.var(market_returns)
    return covariance / market_variance if market_variance != 0 else np.nan

def calcular_sharpe_ratio(returns, risk_free_rate=0.02):
    excess_returns = returns - risk_free_rate / 252
    return np.sqrt(252) * excess_returns.mean() / excess_returns.std()

def calcular_sortino_ratio(returns, risk_free_rate=0.02, target_return=0):
    excess_returns = returns - risk_free_rate / 252
    downside_returns = excess_returns[excess_returns < target_return]
    downside_deviation = np.sqrt(np.mean(downside_returns**2))
    return np.sqrt(252) * excess_returns.mean() / downside_deviation if downside_deviation != 0 else np.nan

# Nuevas funciones para VaR y CVaR
def calcular_var_cvar(returns, confidence=0.95):
    VaR = returns.quantile(1 - confidence)
    CVaR = returns[returns <= VaR].mean()
    return VaR, CVaR

def calcular_var_cvar_ventana(returns, window):
    if len(returns) < window:
        return np.nan, np.nan
    window_returns = returns.iloc[-window:]
    return calcular_var_cvar(window_returns)

def calcular_drawdown(asset):
     data = obtener_datos_acciones(asset, "2010-01-01", "2023-12-31")
     data["Max_Acumulado"] = data[f"{asset}"].cummax()
     data["Drawdown"] = data["Max_Acumulado"] - data.iloc[:,0]
     data["Drawdown (%)"] = (data["Drawdown"] / data["Max_Acumulado"]) * 100
     max_drawdown = data["Drawdown (%)"].max()
     return max_drawdown    
    

def metricas(asset):
            df = obtener_datos_acciones(asset,"2010-01-01", "2023-12-31")
            rend = calcular_rendimientos(df)
            media = rend[f"{asset}"].mean()
            sesgo = rend[f"{asset}"].skew()
            kurtosis = rend[f"{asset}"].kurt()
            var, cvar = calcular_var_cvar(rend[f"{asset}"])
            sharpe = calcular_sharpe_ratio(rend[f"{asset}"]) 
            sortino = calcular_sortino_ratio(rend[f"{asset}"]) 
            drawdown = calcular_drawdown(asset)
            return media, sesgo, kurtosis, var, cvar, sharpe, sortino, drawdown 






def crear_histograma_distribucion(returns, var_95, cvar_95, title):
    # Crear el histograma base
    fig = go.Figure()
    
    # Calcular los bins para el histograma
    counts, bins = np.histogram(returns, bins=50)
    
    # Separar los bins en dos grupos: antes y después del VaR
    mask_before_var = bins[:-1] <= var_95
    
    # Añadir histograma para valores antes del VaR (rojo)
    fig.add_trace(go.Bar(
        x=bins[:-1][mask_before_var],
        y=counts[mask_before_var],
        width=np.diff(bins)[mask_before_var],
        name='Retornos < VaR',
        marker_color='rgba(255, 65, 54, 0.6)'
    ))
    
    # Añadir histograma para valores después del VaR (azul)
    fig.add_trace(go.Bar(
        x=bins[:-1][~mask_before_var],
        y=counts[~mask_before_var],
        width=np.diff(bins)[~mask_before_var],
        name='Retornos > VaR',
        marker_color='rgba(31, 119, 180, 0.6)'
    ))
    
    # Añadir líneas verticales para VaR y CVaR
    fig.add_trace(go.Scatter(
        x=[var_95, var_95],
        y=[0, max(counts)],
        mode='lines',
        name='VaR 95%',
        line=dict(color='green', width=2, dash='dash')
    ))
    
    fig.add_trace(go.Scatter(
        x=[cvar_95, cvar_95],
        y=[0, max(counts)],
        mode='lines',
        name='CVaR 95%',
        line=dict(color='purple', width=2, dash='dot')
    ))
    
    # Actualizar el diseño
    fig.update_layout(
        title=title,
        xaxis_title='Retornos',
        yaxis_title='Frecuencia',
        showlegend=True,
        barmode='overlay',
        bargap=0
    )
    
    return fig